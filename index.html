<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Artera Company Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" rel="stylesheet" />
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    .mapboxgl-popup-content { font:14px/1.5 Arial, sans-serif; }
    #controls {
      position:absolute; top:10px; left:10px; z-index:1;
      background:rgba(255,255,255,0.9); padding:10px; border-radius:4px;
      font-family:Arial,sans-serif; font-size:13px;
    }
    #controls b { display:block; margin-bottom:5px }
    #controls label { display:block; margin-bottom:3px }
  </style>
</head>
<body>
  <div id="controls">
    <b>Filter by Union Status</b>
    <label><input type="checkbox" id="unionChk" checked> Union</label>
    <label><input type="checkbox" id="nonUnionChk" checked> Non-Union</label>
  </div>
  <div id="map"></div>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibXJzaGFyZXBvaW50IiwiYSI6ImNtZHlwcWdmeTA0cG4yam9peGhhNXg0YXQifQ.JnHCLctXF8nC6rOGmWYd5A';

    // Lock to continental USA
    const usaBounds = [[-125,24.396308],[-66.885444,49.384358]];

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v10',
      bounds: usaBounds,
      fitBoundsOptions: { padding:20 },
      maxBounds: usaBounds,
      projection: 'mercator'
    });

    // Add search box
    const geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl });
    map.addControl(geocoder, 'top-left');

    map.on('load', () => {
      fetch('locationdata.geojson')
        .then(r=>r.json())
        .then(data=>{
          // jitter overlapping points
          const groups = {};
          data.features.forEach(f=>{
            (groups[f.properties.state]=groups[f.properties.state]||[]).push(f);
          });
          Object.values(groups).forEach(arr=>{
            const n=arr.length;
            arr.forEach((f,i)=>{
              const [lon,lat]=f.geometry.coordinates;
              const r=0.2,θ=2*Math.PI*i/n;
              f.geometry.coordinates=[lon+Math.cos(θ)*r,lat+Math.sin(θ)*r];
            });
          });

          map.addSource('locations',{ type:'geojson', data });

          map.addLayer({
            id:'points',
            type:'circle',
            source:'locations',
            paint:{
              'circle-radius':6,
              'circle-color':[
                'match',['get','union'],
                'Union','#1f77b4',
                'Non-Union','#9467bd',
                '#888'
              ],
              'circle-stroke-width':1,
              'circle-stroke-color':'#fff'
            }
          });

          // popups
          map.on('
